<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>온도 변수 사이클 수명 시험 모델 — STEAM Project Hub</title>
  <meta name="description" content="I(방전 전류), v(방전 전압), T(주변 온도), 초기 용량 C₀을 입력하면 폐루프 없이 폐쇄형 수식으로 사이클별 방전 용량 궤적을 예측하고 그래프로 표시" />
  <meta name="theme-color" content="#f7f9fc" />
  <style>
    :root{
      --bg:#f7f9fc; --fg:#0d1117; --muted:#536075; --card:#ffffff; --border:#e6eaf1;
      --accent:#3b82f6; --accent2:#14b8a6; --shadow:0 10px 30px rgba(0,0,0,.10); --r:18px;
      --ease:cubic-bezier(.16,1,.3,1);
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial}
    a{color:inherit; text-decoration:none}
    .container{width:min(100%,1100px); margin:0 auto; padding:24px 20px}

    header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(120%) blur(8px);
      background:color-mix(in srgb,var(--bg),transparent 20%); border-bottom:1px solid var(--border)}
    .nav{display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .mark{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--accent),var(--accent2))}

    .hero{padding:26px 0}
    .hero h1{margin:0 0 8px; font-size:clamp(22px,4.2vw,34px); line-height:1.15}
    .hero p{margin:0; color:var(--muted)}
    .crumbs{display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted)}
    .crumbs a{color:var(--muted)}

    .grid{display:grid; gap:18px; grid-template-columns:1fr; align-items:start; margin-top:14px}
    @media (min-width:980px){ .grid{ grid-template-columns: 1.05fr .95fr; } }

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden}
    .card header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .card header h2{margin:0; font-size:18px}
    .card .body{padding:16px}

    .row{display:grid; gap:12px; grid-template-columns: 1fr}
    @media (min-width:720px){
      .row.cols-2{ grid-template-columns: 1fr 1fr; }
      .row.cols-3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .label{font-size:13px; color:var(--muted); margin-bottom:6px}
    .field{position:relative}
    input, select, button{
      width:100%; padding:12px 14px; border-radius:12px; background:color-mix(in srgb,var(--card),transparent 8%);
      border:1px solid var(--border); color:var(--fg); outline:none; transition:border-color .2s var(--ease), box-shadow .2s var(--ease);
    }
    input::placeholder{color:color-mix(in srgb,var(--muted),transparent 30%)}
    input:focus, select:focus{border-color:color-mix(in srgb,var(--accent),transparent 40%); box-shadow:0 0 0 3px color-mix(in srgb,var(--accent),transparent 85%)}

    .with-unit{position:relative}
    .with-unit input{padding-right:64px}
    .with-unit::after{content:attr(data-unit); position:absolute; right:12px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:12px; pointer-events:none}
    .inline{display:flex; gap:8px; align-items:center}
    .inline > *{flex:1}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#6b86ff); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent; color:var(--fg)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .muted{color:var(--muted)}
    .hint{font-size:12px; color:var(--muted)}
    .warn{font-size:12px; color:#d92b2b; margin-top:6px}

    /* 출력 */
    .stats{display:grid; gap:10px; grid-template-columns:1fr; margin-bottom:10px}
    @media (min-width:720px){ .stats{ grid-template-columns: repeat(3, 1fr); } }
    .stat{border:1px solid var(--border); border-radius:12px; padding:12px}
    .stat .k{font-size:12px; color:var(--muted)} .stat .v{font-size:18px; font-weight:700}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--border); border-radius:12px}
    thead th{font-size:12px; color:var(--muted); text-align:left; padding:10px}
    tbody td{padding:10px; border-top:1px solid var(--border)}
    tbody tr:hover{background:color-mix(in srgb,var(--card),transparent 12%)}

    /* 차트 */
    .chart-wrap{border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px}
    canvas{display:block; width:100%; height:300px}
    .legend{display:flex; gap:12px; font-size:12px; color:var(--muted); margin-top:6px}
    .dot{display:inline-block; width:10px; height:10px; border-radius:50%}
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><span class="mark" aria-hidden="true"></span> STEAM Project Hub</div>
    <nav aria-label="보조">
      <a href="index.html" style="font-size:14px; color:var(--muted)">← 홈으로</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="crumbs"><a href="index.html">홈</a> › <span>머신러닝</span> › <span>온도 변수 사이클 수명 시험 모델</span></div>

  <section class="hero">
    <h1>온도 변수 사이클 수명 시험 모델</h1>
    <p class="muted">방정식 기반 모델에 <strong>C₀ 앵커링</strong>을 적용해, 주어진 <em>I, v, T</em>에서의 사이클별 방전용량 궤적을 예측합니다. (선택적으로 파라미터 불확실성 ±1σ 밴드)</p>
  </section>

  <section class="grid">
    <!-- 입력 -->
    <article class="card">
      <header><h2>입력</h2></header>
      <div class="body">
        <div class="row cols-3">
          <div class="field with-unit" data-unit="A">
            <div class="label">Discharging Current (I)</div>
            <input id="I" type="number" step="any" placeholder="예: 1.0" />
          </div>
          <div class="field with-unit" data-unit="V">
            <div class="label">Discharging Voltage (v)</div>
            <input id="V" type="number" step="any" placeholder="예: 3.60" />
          </div>
          <div class="field with-unit" data-unit="°C">
            <div class="label">Ambient Temperature (T)</div>
            <input id="T" type="number" step="any" placeholder="예: 25" />
          </div>
        </div>

        <div class="row cols-3" style="margin-top:8px">
          <div class="field">
            <div class="label">초기 방전 용량 C₀</div>
            <div class="inline">
              <input id="C0" type="number" step="any" placeholder="예: 2500" />
              <select id="C0unit" style="max-width:120px">
                <option value="mAh" selected>mAh</option>
                <option value="Ah">Ah</option>
              </select>
            </div>
          </div>
          <div class="field">
            <div class="label">시작 사이클 N₀</div>
            <input id="N0" type="number" step="1" value="1" />
          </div>
          <div class="field">
            <div class="label">예측 길이 (스텝 수)</div>
            <input id="STEPS" type="number" step="1" value="600" />
          </div>
        </div>

        <div class="row cols-3" style="margin-top:8px">
          <div class="field with-unit" data-unit="×C₀">
            <div class="label">EOL 비율(≤이면 중단)</div>
            <input id="EOL" type="number" step="0.01" value="0.80" />
          </div>
          <div class="field">
            <div class="label">신뢰구간 표시</div>
            <div class="inline">
              <select id="ciMode">
                <option value="off" selected>끄기</option>
                <option value="1sigma">±1σ 밴드</option>
              </select>
              <input id="nSamples" type="number" step="1" min="10" value="200" title="샘플 수(±1σ 계산용)" />
            </div>
          </div>
          <div class="field">
            <div class="label">CSV 내보내기</div>
            <button class="btn ghost" id="dlCsv" type="button" disabled>CSV 다운로드</button>
          </div>
        </div>

        <details style="margin-top:10px">
          <summary class="muted">고급: 파라미터 (편집 가능, 기본값=후단 추정 평균±표준편차)</summary>
          <div class="row cols-3" style="margin-top:10px">
            <div class="field"><div class="label">a (mean)</div><input id="a_mu" type="number" step="any" value="0.1827" /></div>
            <div class="field"><div class="label">b (mean)</div><input id="b_mu" type="number" step="any" value="0.0674" /></div>
            <div class="field"><div class="label">c (mean)</div><input id="c_mu" type="number" step="any" value="0.0013" /></div>
          </div>
          <div class="row cols-3" style="margin-top:8px">
            <div class="field"><div class="label">d (mean)</div><input id="d_mu" type="number" step="any" value="-4.6316" /></div>
            <div class="field"><div class="label">σ(a)</div><input id="a_sd" type="number" step="any" value="0.2789" /></div>
            <div class="field"><div class="label">σ(b)</div><input id="b_sd" type="number" step="any" value="0.0365" /></div>
          </div>
          <div class="row cols-3" style="margin-top:8px">
            <div class="field"><div class="label">σ(c)</div><input id="c_sd" type="number" step="any" value="0.0004" /></div>
            <div class="field"><div class="label">σ(d)</div><input id="d_sd" type="number" step="any" value="1.0218" /></div>
          </div>
        </details>

        <div class="actions">
          <button class="btn" id="demoBtn" type="button">데모 로드</button>
          <button class="btn primary" id="runBtn" type="button">실행</button>
          <button class="btn ghost" id="clearBtn" type="button">초기화</button>
          <span class="hint">입력 후 실행을 누르면 그래프와 표가 생성됩니다.</span>
        </div>
        <div id="warn" class="warn"></div>
      </div>
    </article>

    <!-- 출력 -->
    <article class="card">
      <header><h2>출력</h2></header>
      <div class="body">
        <div class="chart-wrap">
          <canvas id="chart" width="800" height="300" aria-label="용량 예측 차트"></canvas>
          <div class="legend">
            <span><span class="dot" style="background:#3b82f6"></span> 예측(평균 파라미터)</span>
            <span><span class="dot" style="background:#a78bfa"></span> ±1σ 밴드(옵션)</span>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div class="k">첫 예측 (N₀)</div><div class="v" id="statFirst">—</div></div>
          <div class="stat"><div class="k">마지막 (N₀+K)</div><div class="v" id="statLast">—</div></div>
          <div class="stat"><div class="k">EOL 도달 사이클</div><div class="v" id="statEOL">—</div></div>
        </div>

        <table id="outTable" aria-label="예측 테이블">
          <thead><tr><th>Cycle N</th><th>capacity_hat</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </article>
  </section>
</main>

<script>
  /* ===== 유틸 ===== */
  const $ = id => document.getElementById(id);
  const warn = (m) => { $('warn').textContent = m || ''; };

  function toAh(val, unit){ return unit === 'mAh' ? Number(val)/1000 : Number(val); }
  function fromAh(valAh, unit){ return unit === 'mAh' ? Number(valAh)*1000 : Number(valAh); }
  function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

  // 가우시안 샘플러(박스-뮬러)
  function randn(){ let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
  function sampleNormal(mu, sd){ return mu + sd*randn(); }

  // 모델 수식 (정규화 용량)
  function qnorm(N, pars, V, T, I){
    const {a,b,c,d} = pars;
    const term1 = 2 - (a*T*N)*Math.exp(d*I);
    const term2 = Math.exp(b*(V-1.5)) * Math.exp(c*N);
    return term1 - term2;
  }

  // 차트
  function drawChart(xs, ys, bandLo=null, bandHi=null, unitLabel='mAh'){
    const canvas = $('chart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,cssW,cssH);

    if(!(xs && xs.length && ys && ys.length)) return;

    const left=48, right=10, top=12, bottom=28;
    const W = cssW - left - right, H = cssH - top - bottom;

    const allY = [...ys];
    if(bandLo && bandHi){
      for(let i=0;i<bandLo.length;i++){ allY.push(bandLo[i], bandHi[i]); }
    }
    const minX = xs[0], maxX = xs[xs.length-1];
    const minY = Math.min(...allY), maxY = Math.max(...allY);

    const xmap = x => left + (W*(x-minX))/Math.max(1,(maxX-minX));
    const ymap = y => top + H - (H*(y-minY))/Math.max(1e-9,(maxY-minY));

    // 축
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border') || '#e6eaf1';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, top+H); ctx.lineTo(left+W, top+H); ctx.stroke();

    // CI 밴드
    if(bandLo && bandHi){
      ctx.fillStyle = 'rgba(167,139,250,0.22)'; // 보라 연한
      ctx.beginPath();
      ctx.moveTo(xmap(xs[0]), ymap(bandLo[0]));
      for(let i=1;i<xs.length;i++) ctx.lineTo(xmap(xs[i]), ymap(bandLo[i]));
      for(let i=xs.length-1;i>=0;i--) ctx.lineTo(xmap(xs[i]), ymap(bandHi[i]));
      ctx.closePath(); ctx.fill();
    }

    // 예측선
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xmap(xs[0]), ymap(ys[0]));
    for(let i=1;i<xs.length;i++) ctx.lineTo(xmap(xs[i]), ymap(ys[i]));
    ctx.stroke();

    // 라벨
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted') || '#536075';
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
    ctx.textAlign='center'; ctx.fillText('Cycle (N)', left+W/2, cssH-6);
    ctx.save(); ctx.translate(16, top+H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Capacity ('+unitLabel+')', 0, 0); ctx.restore();
  }

  // CSV
  function download(name, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click();
    URL.revokeObjectURL(url);
  }

  function runOnce(){
    try{
      warn('');
      const I = Number($('I').value), V = Number($('V').value), T = Number($('T').value);
      const C0 = Number($('C0').value); const unit = $('C0unit').value;
      const N0 = Math.round(Number($('N0').value)||1);
      const STEPS = Math.max(1, Math.round(Number($('STEPS').value)||600));
      const EOLrat = Number($('EOL').value)||0.8;
      if(![I,V,T,C0].every(Number.isFinite)) { warn('I, v, T, C₀를 모두 입력하세요.'); return; }

      const pars_mu = {
        a:Number($('a_mu').value), b:Number($('b_mu').value),
        c:Number($('c_mu').value), d:Number($('d_mu').value),
      };
      const pars_sd = {
        a:Math.abs(Number($('a_sd').value)||0),
        b:Math.abs(Number($('b_sd').value)||0),
        c:Math.abs(Number($('c_sd').value)||0),
        d:Math.abs(Number($('d_sd').value)||0),
      };

      const C0_Ah = toAh(C0, unit);
      const xs = []; const ys = [];
      let eolCycle = null;

      // 앵커 스케일
      const y0 = qnorm(N0, pars_mu, V, T, I);
      const scale = C0_Ah / (Math.abs(y0) > 1e-12 ? y0 : 1e-12);

      for(let k=0;k<STEPS;k++){
        const N = N0 + k;
        const yNorm = qnorm(N, pars_mu, V, T, I);
        let capAh = scale * yNorm;
        capAh = Math.max(0, capAh); // 음수 방지
        xs.push(N);
        ys.push(fromAh(capAh, unit));

        if(eolCycle===null && capAh <= EOLrat*C0_Ah) eolCycle = N;
      }

      // CI 옵션(±1σ)
      let bandLo=null, bandHi=null;
      if($('ciMode').value === '1sigma'){
        const S = Math.max(10, Math.round(Number($('nSamples').value)||200));
        const sum = new Array(STEPS).fill(0);
        const sumsq = new Array(STEPS).fill(0);

        for(let s=0;s<S;s++){
          const pars_s = {
            a: sampleNormal(pars_mu.a, pars_sd.a),
            b: sampleNormal(pars_mu.b, pars_sd.b),
            c: sampleNormal(pars_mu.c, pars_sd.c),
            d: sampleNormal(pars_mu.d, pars_sd.d),
          };
          const y0s = qnorm(N0, pars_s, V, T, I);
          const scales = C0_Ah / (Math.abs(y0s)>1e-12 ? y0s : 1e-12);

          for(let k=0;k<STEPS;k++){
            const N = N0 + k;
            const yNorm = qnorm(N, pars_s, V, T, I);
            const cap = Math.max(0, scales*yNorm);
            const capUI = fromAh(cap, unit);
            sum[k] += capUI;
            sumsq[k] += capUI*capUI;
          }
        }
        const mean = sum.map(v => v/S);
        const std  = sum.map((v,i) => Math.sqrt(Math.max(0, sumsq[i]/S - (mean[i]**2))));
        bandLo = mean.map((m,i)=> m - std[i]);
        bandHi = mean.map((m,i)=> m + std[i]);
      }

      // 렌더
      drawChart(xs, ys, bandLo, bandHi, unit);
      $('statFirst').textContent = ys.length? ys[0].toFixed(6) + ' ' + unit : '—';
      $('statLast').textContent  = ys.length? ys[ys.length-1].toFixed(6) + ' ' + unit : '—';
      $('statEOL').textContent   = eolCycle ?? '—';

      // 표(상위 10개)
      const tb = $('outTable').querySelector('tbody');
      tb.innerHTML = '';
      for(let i=0;i<Math.min(10, xs.length); i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${xs[i]}</td><td>${ys[i].toFixed(8)}</td>`;
        tb.appendChild(tr);
      }

      // CSV
      const rows = xs.map((N,i)=> ({cycle:N, capacity_hat:ys[i]}));
      const head = 'cycle,capacity_hat\n';
      const body = rows.map(r=> `${r.cycle},${r.capacity_hat}`).join('\n') + '\n';
      $('dlCsv').disabled = false;
      $('dlCsv').onclick = ()=> download('temp_life_rollout.csv', head+body);

    }catch(e){
      console.error(e);
      warn('실행 오류: '+(e?.message||e));
      alert('실행 중 오류가 발생했습니다. 콘솔을 확인해 주세요.');
    }
  }

  // 이벤트
  $('runBtn').addEventListener('click', runOnce);
  $('demoBtn').addEventListener('click', ()=>{
    $('I').value = '1.0';
    $('V').value = '3.60';
    $('T').value = '25';
    $('C0').value= '2500';
    $('C0unit').value='mAh';
    $('N0').value= '1';
    $('STEPS').value='600';
    $('EOL').value='0.80';
    $('ciMode').value='1sigma';
    $('nSamples').value='200';
    warn('');
  });
  $('clearBtn').addEventListener('click', ()=>{
    ['I','V','T','C0','N0','STEPS','EOL'].forEach(id=> $(id).value='');
    $('C0unit').value='mAh';
    $('ciMode').value='off';
    $('nSamples').value='200';
    // 초기 상태로 차트/표/통계 비우기
    const ctx = $('chart').getContext('2d'); ctx.clearRect(0,0,$('chart').width, $('chart').height);
    $('outTable').querySelector('tbody').innerHTML='';
    $('statFirst').textContent='—'; $('statLast').textContent='—'; $('statEOL').textContent='—';
    $('dlCsv').disabled = true;
    warn('');
  });
</script>
</body>
</html>
