<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>상구간 입력 → 하구간 Capacity 예측 (V–Q 전체곡선)</title>
  <meta name="theme-color" content="#f7f9fc" />
  <style>
    :root{
      --bg:#f7f9fc; --fg:#0d1117; --muted:#536075; --card:#ffffff; --border:#e6eaf1;
      --accent:#3b82f6; --accent2:#14b8a6; --shadow:0 10px 30px rgba(0,0,0,.10); --r:18px;
      --ease:cubic-bezier(.16,1,.3,1);
      color-scheme: light;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial}
    a{color:inherit;text-decoration:none}
    .container{width:min(100%,1100px);margin:0 auto;padding:24px 20px}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(120%) blur(8px);
      background:color-mix(in srgb,var(--bg),transparent 20%); border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    .crumbs{display:flex;gap:8px;align-items:center;font-size:14px;color:var(--muted)}
    .crumbs a{color:var(--muted)}
    .hero{padding:26px 0}
    .hero h1{margin:0 0 8px;font-size:clamp(22px,4.2vw,34px);line-height:1.15}
    .hero p{margin:0;color:var(--muted)}
    .grid{display:grid;gap:18px;grid-template-columns:1fr;align-items:start;margin-top:14px}
    @media (min-width:980px){ .grid{ grid-template-columns: 1.05fr .95fr; } }
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .card header h2{margin:0;font-size:18px}
    .card .body{padding:16px}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:720px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input, textarea, select, button{
      width:100%;padding:10px 12px;border-radius:12px;background:color-mix(in srgb,var(--card),transparent 8%);
      border:1px solid var(--border);color:var(--fg);outline:none;transition:border-color .2s var(--ease),box-shadow .2s var(--ease)
    }
    input::placeholder, textarea::placeholder{color:color-mix(in srgb,var(--muted),transparent 30%)}
    input:focus, textarea:focus, select:focus{border-color:color-mix(in srgb,var(--accent),transparent 40%);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent),transparent 85%)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#6b86ff);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hint{font-size:12px;color:var(--muted)}
    .warn{font-size:12px;color:#d92b2b;min-height:1.2em}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:8px}
    tbody td{padding:8px;border-top:1px solid var(--border)}
    .chart-wrap{border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    canvas{display:block;width:100%;height:360px}
    .stats{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:720px){ .stats{grid-template-columns:repeat(3,1fr)} }
    .stat{border:1px solid var(--border);border-radius:12px;padding:12px}
    .stat .k{font-size:12px;color:var(--muted)} .stat .v{font-size:18px;font-weight:700}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><span class="mark" aria-hidden="true"></span> STEAM Project Hub</div>
    <nav aria-label="보조">
      <a href="index.html" style="font-size:14px;color:var(--muted)">← 홈으로</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="crumbs"><a href="index.html">홈</a> › <span>머신러닝</span> › <span>상구간→하구간 Capacity 예측</span></div>
  <section class="hero">
    <h1>상구간 입력 → 하구간 Capacity 예측</h1>
    <p class="muted">상구간 Q(4.20→3.89 V) 32점 + dQ/dV(4.20~3.80 V 임의 샘플)를 넣으면 3rd 피크를 추출해 ONNX(34차)로 하구간 Capacity를 예측합니다. X=Capacity(Ah), Y=Voltage(V)로 전체 곡선을 그립니다.</p>
  </section>

  <section class="grid">
    <!-- 좌: 입력 카드들 -->
    <article class="card">
      <header><h2>입력</h2></header>
      <div class="body">
        <!-- Q 32점 -->
        <div class="label"><strong>① 상구간 Q 32점</strong> — 전압 고정: 4.20→3.89 V(0.01 V step, 총 32개), 단위 Ah</div>

        <div class="row cols-2">
          <div>
            <div class="label">CSV/엑셀에서 복사한 한 줄(또는 한 열) 그대로 붙여넣기</div>
            <textarea id="upperQText" rows="4" placeholder="예)\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001,0.00273913,0.004830189,0.007767073,0.011569565,0.016281481,0.022136364,0.029384848,0.03862963,0.050418182,0.065605882,0.086,0.11234,0.1462,0.187585714,0.23498,0.28654"></textarea>
            <div class="actions">
              <button class="btn" id="applyUpperQ">붙여넣기 값 → 32칸 자동 분배</button>
              <span class="hint">쉼표/탭/공백/줄바꿈 모두 인식 · 32개 미만/초과 시 경고</span>
            </div>
          </div>
          <div>
            <div class="label">데모/초기화</div>
            <div class="actions">
              <button class="btn" id="fillDemoQ">예시로 채우기</button>
              <button class="btn ghost" id="clearQ">초기화</button>
            </div>
            <div id="qPasteInfo" class="hint" style="margin-top:6px"></div>
          </div>
        </div>

        <div style="margin:10px 0 14px; max-height:280px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
          <table>
            <thead><tr><th>Voltage (V)</th><th>Capacity Q (Ah)</th></tr></thead>
            <tbody id="qTable"></tbody>
          </table>
        </div>

        <!-- dQ/dV 업로드/붙여넣기 -->
        <div class="label" style="margin-top:6px"><strong>② dQ/dV 샘플</strong> (권장 범위: 4.20~3.80 V / CSV 업로드 또는 텍스트 붙여넣기, 열: <span class="mono">V,dQdV</span>)</div>
        <div class="row cols-2">
          <div>
            <div class="label">CSV 업로드</div>
            <input type="file" id="dqdvFile" accept=".csv,text/csv" />
          </div>
          <div>
            <div class="label">텍스트 붙여넣기 (행당 “V dQdV” 또는 “V,dQdV”)</div>
            <textarea id="dqdvText" rows="6" placeholder="예)\n4.20, 0.85\n4.19, 0.83\n..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="fillDemoDqdv">dQ/dV 예시로 채우기</button>
          <button class="btn ghost" id="clearDqdv">초기화</button>
          <span class="hint">내부 스무딩 & 피크검출 → 전압 내림차순 기준 3번째 피크 사용(없으면 prominence 최대)</span>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0" />
        <div class="actions">
          <button class="btn primary" id="runBtn">예측 실행</button>
          <span class="hint">모델 경로: <span class="mono">models/soc-cycle/lowercap_fused.onnx</span></span>
        </div>
        <div id="warn" class="warn"></div>

        <div class="row cols-2" style="margin-top:10px">
          <div class="stat"><div class="k">추출된 dQ/dV 피크(강도)</div><div class="v" id="pkI">—</div></div>
          <div class="stat"><div class="k">추출된 dQ/dV 피크(전압)</div><div class="v" id="pkV">—</div></div>
        </div>
      </div>
    </article>

    <!-- 우: 출력 -->
    <article class="card" id="outCard">
      <header><h2>출력</h2></header>
      <div class="body">
        <div class="chart-wrap">
          <canvas id="chart" width="900" height="360" aria-label="V–Q 예측 곡선"></canvas>
        </div>
        <div class="stats">
          <div class="stat"><div class="k">상구간 Q 최댓값(Ah)</div><div class="v" id="qMax">—</div></div>
          <div class="stat"><div class="k">하구간 예측 길이(pts)</div><div class="v" id="lowLen">—</div></div>
          <div class="stat"><div class="k">전압 범위(V)</div><div class="v" id="vRange">—</div></div>
        </div>
        <div class="hint">그래프: X=Capacity(Ah), Y=Voltage(V). 파란선=상구간 입력, 초록선=하구간 예측.</div>
      </div>
    </article>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script>
/* ===== 모델 경로 ===== */
const MODEL_PATH = "models/soc-cycle/lowercap_fused.onnx";

/* ===== 전역 ===== */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const warn = m => $("warn").textContent = m || "";

/* 상구간 전압: 4.20 → 3.89 V (0.01 step, 32점 고정) */
const UPPER_VS = Array.from({length:32}, (_,i)=> +(4.20 - 0.01*i).toFixed(2));
const LOWER_START_V = 3.88;
const LOWER_STEP = 0.01;
let session = null;

/* ===== Q 테이블 빌드 ===== */
function buildQTable(){
  const tb = $("qTable"); tb.innerHTML = "";
  UPPER_VS.forEach((v,i)=>{
    const tr = document.createElement("tr");
    const tdV = document.createElement("td");
    tdV.textContent = v.toFixed(2);
    const tdQ = document.createElement("td");
    const inp = document.createElement("input");
    inp.type = "number"; inp.step = "any"; inp.placeholder = "Ah"; inp.id = `q_${i}`;
    tdQ.appendChild(inp);
    tr.appendChild(tdV); tr.appendChild(tdQ);
    tb.appendChild(tr);
  });
}
buildQTable();

/* ===== 상구간 Q 일괄 붙여넣기 파서 ===== */
function parseNumbersFromText(text){
  if(!text) return [];
  // 숫자/소수/지수 표기만 남기고 분리
  const tokens = text.replace(/[^\d.eE+\- ,\t\r\n;]/g, ' ')
                     .split(/[,;\s]+/).filter(Boolean);
  const nums = [];
  for(const t of tokens){
    const v = parseFloat(t);
    if(Number.isFinite(v)) nums.push(v);
  }
  return nums;
}

function applyUpperQPaste(){
  const txt = $("upperQText").value.trim();
  const nums = parseNumbersFromText(txt);
  const info = $("qPasteInfo");
  if(nums.length < 32){
    info.textContent = `감지된 유효 숫자: ${nums.length}개 (32개 필요)`;
    warn("상구간 Q 값이 32개 미만입니다.");
    return;
  }
  if(nums.length > 32){
    warn("32개 초과 입력: 처음 32개만 사용합니다.");
  }else{
    warn("");
  }
  for(let i=0;i<32;i++){
    $("q_"+i).value = (nums[i] ?? "").toString();
  }
  info.textContent = `32개 적용 완료 (감지 ${nums.length}개 중 32개 사용)`;
}
$("applyUpperQ").addEventListener("click", applyUpperQPaste);

/* ===== 데모/초기화 ===== */
$("fillDemoQ").addEventListener("click", ()=>{
  const base = 2.10;
  for(let i=0;i<UPPER_VS.length;i++){
    const val = base - 0.002*i - 0.0005*Math.sin(i/3);
    $("q_"+i).value = val.toFixed(4);
  }
  $("qPasteInfo").textContent = "";
});
$("clearQ").addEventListener("click", ()=>{
  for(let i=0;i<UPPER_VS.length;i++) $("q_"+i).value = "";
  $("upperQText").value = "";
  $("qPasteInfo").textContent = "";
});

/* ===== dQ/dV 입력 처리 ===== */
$("fillDemoDqdv").addEventListener("click", ()=>{
  const rows = [];
  for(let k=0;k<=20;k++){
    const V = 4.20 - 0.02*k;
    const dqdv = 0.8*Math.exp(-((V-4.05)*(V-4.05))/0.01) + 0.12*Math.random();
    rows.push(`${V.toFixed(2)}, ${dqdv.toFixed(4)}`);
  }
  $("dqdvText").value = rows.join("\n");
});
$("clearDqdv").addEventListener("click", ()=>{
  $("dqdvText").value = "";
  $("dqdvFile").value = "";
});
$("dqdvFile").addEventListener("change", async ()=>{
  const f = $("dqdvFile").files?.[0]; if(!f) return;
  const text = await f.text();
  $("dqdvText").value = text.trim();
});

function parseDqdvText(){
  let text = $("dqdvText").value.trim();
  const out = [];
  if(!text) return out;
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let start = 0;
  if(lines[0].toLowerCase().includes("v") && (lines[0].toLowerCase().includes("dq") || lines[0].toLowerCase().includes("dqdv"))) start = 1;
  for(let i=start;i<lines.length;i++){
    const parts = lines[i].split(/[, \t;]+/).map(s=>s.trim()).filter(Boolean);
    if(parts.length<2) continue;
    const V = parseFloat(parts[0]);
    const D = parseFloat(parts[1]);
    if(Number.isFinite(V) && Number.isFinite(D)) out.push({V, D});
  }
  out.sort((a,b)=> b.V - a.V); // 전압 내림차순
  return out;
}

function smoothMovingAvg(arr, win=7){
  if(win<3 || win%2===0) win=7;
  const half = Math.floor(win/2);
  const out = new Array(arr.length).fill(0);
  for(let i=0;i<arr.length;i++){
    let s=0,c=0;
    for(let j=i-half;j<=i+half;j++){
      if(j>=0 && j<arr.length){ s+=arr[j]; c++; }
    }
    out[i]= s/c;
  }
  return out;
}
function findPeaks(x, y, win=6, minProm=0.01){
  const peaks = [];
  for(let i=1;i<y.length-1;i++){
    if(y[i-1] < y[i] && y[i] > y[i+1]){
      const l0 = Math.max(0, i-win), r0 = Math.min(y.length-1, i+win);
      let leftMin = Infinity, rightMin = Infinity;
      for(let k=l0;k<i;k++) leftMin = Math.min(leftMin, y[k]);
      for(let k=i+1;k<=r0;k++) rightMin = Math.min(rightMin, y[k]);
      const prom = y[i] - Math.max(leftMin, rightMin);
      if(prom >= minProm){
        peaks.push({idx:i, V:x[i], mag:y[i], prom});
      }
    }
  }
  return peaks;
}
function extractThirdPeak(dqdvRows){
  if(dqdvRows.length<5) return null;
  const V = dqdvRows.map(r=>r.V);
  const D = dqdvRows.map(r=>r.D);
  const Ds = smoothMovingAvg(D, 7);
  const peaks = findPeaks(V, Ds, 6, 0.01);
  if(peaks.length===0){
    let mi = 0; for(let i=1;i<Ds.length;i++) if(Ds[i]>Ds[mi]) mi=i;
    return {peakI: Ds[mi], peakV: V[mi], debug:{mode:"global-max"}};
  }
  const sortedByPos = peaks.sort((a,b)=> a.idx - b.idx);
  const third = sortedByPos[2] || null;
  if(third) return {peakI: third.mag, peakV: third.V, debug:{mode:"3rd-desc"}};
  const byProm = [...peaks].sort((a,b)=> b.prom - a.prom);
  const top = byProm[0];
  return {peakI: top.mag, peakV: top.V, debug:{mode:"max-prom"}};
}

/* ===== ONNX ===== */
async function ensureSession(){
  if(session) return session;
  ort.env.wasm.numThreads = 3;
  ort.env.wasm.proxy = false;
  session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders:["wasm"] });
  return session;
}

/* ===== 유틸 ===== */
function readUpperQ(){
  const arr = [];
  for(let i=0;i<32;i++){
    const v = parseFloat($("q_"+i).value);
    if(!Number.isFinite(v)) return null;
    arr.push(v);
  }
  return arr;
}
function makeLowerVoltages(n){
  return Array.from({length:n}, (_,i)=> +(LOWER_START_V - i*LOWER_STEP).toFixed(2));
}
function drawQV(upperV, upperQ, lowerV, lowerQ){
  const c=$("chart"), ctx=c.getContext("2d"), dpr=window.devicePixelRatio||1;
  const W=c.clientWidth, H=c.clientHeight; c.width=W*dpr; c.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);
  if((upperV.length===0||upperQ.length===0) && (lowerV.length===0||lowerQ.length===0)) return;

  const allQ = [...upperQ, ...lowerQ].filter(Number.isFinite);
  const allV = [...upperV, ...lowerV].filter(Number.isFinite);
  const qMin = Math.min(...allQ), qMax = Math.max(...allQ);
  const vMin = Math.min(...allV), vMax = Math.max(...allV);
  const L=54,R=16,T=14,B=32, w=W-L-R, h=H-T-B;

  const x = (q)=> L + ( (q - qMin) / Math.max(1e-12, (qMax-qMin)) ) * w;
  const y = (v)=> T + (1 - ( (v - vMin) / Math.max(1e-12,(vMax-vMin)) )) * h;

  // 축
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--border')||'#e6eaf1';
  ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+h); ctx.lineTo(L+w,T+h); ctx.stroke();

  // Q 틱
  ctx.fillStyle='#8a93a5'; ctx.font='12px system-ui';
  for(let i=0;i<=4;i++){
    const tq = qMin + (qMax-qMin)*i/4;
    const tx = x(tq); ctx.fillText(tq.toFixed(2), tx-10, T+h+18);
    ctx.strokeStyle='rgba(0,0,0,0.06)'; ctx.beginPath(); ctx.moveTo(tx,T); ctx.lineTo(tx,T+h); ctx.stroke();
  }
  // V 틱
  for(let i=0;i<=4;i++){
    const tv = vMin + (vMax-vMin)*i/4;
    const ty = y(tv); ctx.fillText(tv.toFixed(2), 6, ty+4);
    ctx.strokeStyle='rgba(0,0,0,0.06)'; ctx.beginPath(); ctx.moveTo(L,ty); ctx.lineTo(L+w,ty); ctx.stroke();
  }

  // 상구간(파랑)
  if(upperQ.length){
    ctx.strokeStyle='#3b82f6'; ctx.lineWidth=2; ctx.beginPath();
    ctx.moveTo(x(upperQ[0]), y(upperV[0]));
    for(let i=1;i<upperQ.length;i++) ctx.lineTo(x(upperQ[i]), y(upperV[i]));
    ctx.stroke();
  }
  // 하구간(초록)
  if(lowerQ.length){
    ctx.strokeStyle='#16a34a'; ctx.lineWidth=2; ctx.beginPath();
    ctx.moveTo(x(lowerQ[0]), y(lowerV[0]));
    for(let i=1;i<lowerQ.length;i++) ctx.lineTo(x(lowerQ[i]), y(lowerV[i]));
    ctx.stroke();
  }
}

/* ===== 실행 ===== */
$("runBtn").addEventListener("click", async ()=>{
  try{
    warn("");
    // 1) 상구간 Q 32점
    const upperQ = readUpperQ();
    if(!upperQ){ warn("상구간 Q 32개를 모두 숫자로 입력하거나, 일괄 붙여넣기 후 적용 버튼을 눌러주세요."); return; }

    // 2) dQ/dV 파싱 → 피크 추출
    const rows = parseDqdvText();
    if(rows.length < 10){ warn("dQ/dV 데이터가 너무 적습니다. 4.20~3.80 V 구간을 충분히 포함해 주세요."); return; }
    const peak = extractThirdPeak(rows);
    if(!peak){ warn("dQ/dV에서 피크를 추출하지 못했습니다. 데이터 범위를 확인하세요."); return; }
    $("pkI").textContent = peak.peakI.toFixed(6);
    $("pkV").textContent = peak.peakV.toFixed(4);

    // 3) ONNX 실행(입력 34차: Q(32) + [peakI, peakV])
    const sess = await ensureSession();
    const inputName = sess.inputNames[0];
    const feats = new Float32Array(34);
    for(let i=0;i<32;i++) feats[i] = upperQ[i];
    feats[32] = peak.peakI;
    feats[33] = peak.peakV;

    const feeds = {}; feeds[inputName] = new ort.Tensor('float32', feats, [1,34]);
    const out = await sess.run(feeds);
    const outName = sess.outputNames[0];
    const y = out[outName].data; // 예측된 하구간 Q

    // 4) 하구간 전압 그리드
    const lowerV = makeLowerVoltages(y.length);
    const lowerQ = Array.from(y);

    // 5) 렌더링
    const upperV = [...UPPER_VS]; // 4.20→3.89
    drawQV(upperV, upperQ, lowerV, lowerQ);

    // 6) 요약
    $("qMax").textContent = Math.max(...upperQ).toFixed(6);
    $("lowLen").textContent = String(lowerQ.length);
    const allV = [...upperV, ...lowerV];
    $("vRange").textContent = `${Math.max(...allV).toFixed(2)} → ${Math.min(...allV).toFixed(2)}`;

  }catch(e){
    console.error(e);
    warn("실행 오류: " + (e?.message || e));
  }
});

/* 초기 안내 */
warn("상구간 Q는 32개 고정 전압(4.20→3.89 V)입니다. CSV/엑셀에서 값 32개를 복사해 붙여넣기 후 [자동 분배]를 누르세요. dQ/dV는 4.20~3.80 V 범위를 충분히 포함해 주세요.");
</script>
</body>
</html>
