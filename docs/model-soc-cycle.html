<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>상단 V–Q → 하단 용량 예측 — STEAM Project Hub</title>
  <meta name="description" content="상단 전압 구간의 32개 Q와 dQ/dV 피크(세기·전압)를 입력받아 하단 전압 구간의 용량 곡선을 예측하여 Capacity–Voltage 그래프로 출력" />
  <meta name="theme-color" content="#f7f9fc" />
  <style>
    :root{
      --bg:#f7f9fc; --fg:#0d1117; --muted:#536075; --card:#ffffff; --border:#e6eaf1;
      --accent:#3b82f6; --accent2:#14b8a6; --shadow:0 10px 30px rgba(0,0,0,.10); --r:18px;
      --ease:cubic-bezier(.16,1,.3,1);
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial}
    a{color:inherit;text-decoration:none}
    .container{width:min(100%,1100px);margin:0 auto;padding:24px 20px}

    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(120%) blur(8px);
      background:color-mix(in srgb,var(--bg),transparent 20%);border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    .crumbs{display:flex;gap:8px;align-items:center;font-size:14px;color:var(--muted)}
    .crumbs a{color:var(--muted)}
    .hero{padding:26px 0}
    .hero h1{margin:0 0 8px;font-size:clamp(22px,4.2vw,34px);line-height:1.15}
    .hero p{margin:0;color:var(--muted)}

    .grid{display:grid;gap:18px;grid-template-columns:1fr;align-items:start;margin-top:14px}
    @media (min-width:980px){ .grid{grid-template-columns:1.05fr .95fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .card header h2{margin:0;font-size:18px}
    .card .body{padding:16px}

    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:720px){
      .row.cols-2{grid-template-columns:1fr 1fr}
      .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    }
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input,.field textarea,.field select,.field button{
      width:100%;padding:12px 14px;border-radius:12px;background:color-mix(in srgb,var(--card),transparent 8%);
      border:1px solid var(--border);color:var(--fg);outline:none;
      transition:border-color .2s var(--ease), box-shadow .2s var(--ease)
    }
    input::placeholder,textarea::placeholder{color:color-mix(in srgb,var(--muted),transparent 30%)}
    input:focus,textarea:focus,select:focus{border-color:color-mix(in srgb,var(--accent),transparent 40%);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent),transparent 85%)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#6b86ff);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent;color:var(--fg)}
    .hint{font-size:12px;color:var(--muted)}
    .warn{font-size:12px;color:#d92b2b;min-height:1.2em}

    .chart-wrap{border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    canvas{display:block;width:100%;height:300px}

    .legend{display:flex;gap:10px;align-items:center;margin:8px 0 12px}
    .lg{display:inline-flex;gap:6px;align-items:center;font-size:13px;color:var(--muted)}
    .dot{width:12px;height:12px;border-radius:3px;background:#3b82f6;border:1px solid color-mix(in srgb,#000,transparent 80%)}
    .dot.gray{background:#9aa5b1}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:10px}
    tbody td{padding:10px;border-top:1px solid var(--border)}
    tbody tr:hover{background:color-mix(in srgb,var(--card),transparent 12%)}
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><span class="mark" aria-hidden="true"></span> STEAM Project Hub</div>
    <nav aria-label="보조">
      <a href="index.html" style="font-size:14px;color:var(--muted)">← 홈으로</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="crumbs"><a href="index.html">홈</a> › <span>머신러닝</span> › <span>상단→하단 용량 예측</span></div>

  <section class="hero">
    <h1>상단 V–Q 입력 → 하단 용량 곡선 예측</h1>
    <p class="muted">입력: 4.20→3.89V 구간의 Q 32개(전압 내림차순) + dQ/dV 피크(세기, 전압). 출력: 3.88→2.50V 구간의 예측 Q를 병합한 Capacity–Voltage 곡선.</p>
  </section>

  <section class="grid">
    <!-- 입력 카드 -->
    <article class="card">
      <header><h2>입력</h2></header>
      <div class="body">
        <div class="row">
          <div class="field">
            <div class="label">상단 Q 32개 (4.20 → 3.89 V 순서, 쉼표/공백/개행 구분 허용)</div>
            <textarea id="Q32" rows="5" placeholder="예) 0.00, 0.03, 0.07, 0.10, ... (총 32개)"></textarea>
            <div class="hint">전압 격자: 4.20, 4.19, …, 3.90, 3.89 (32개)</div>
          </div>
        </div>

        <div class="row cols-2">
          <div class="field">
            <div class="label">dQ/dV Peak Intensity (세기)</div>
            <input id="peakI" type="number" step="any" placeholder="예: 0.12" />
          </div>
          <div class="field">
            <div class="label">dQ/dV Peak Voltage (V)</div>
            <input id="peakV" type="number" step="any" placeholder="예: 3.95" />
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="runBtn" type="button">예측 실행</button>
          <button class="btn" id="demoBtn" type="button">데모 채우기</button>
          <button class="btn" id="clearBtn" type="button">초기화</button>
          <span class="hint">모델 경로가 맞는지 확인: <code>PATHS.LOWER</code></span>
        </div>
        <div id="warn" class="warn"></div>
      </div>
    </article>

    <!-- 출력 카드 -->
    <article class="card">
      <header><h2>출력</h2></header>
      <div class="body">
        <div class="legend">
          <span class="lg"><span class="dot gray"></span> 상단(입력) 구간 — 4.20→3.89V</span>
          <span class="lg"><span class="dot"></span> 하단(예측) 구간 — 3.88→2.50V</span>
        </div>
        <div class="chart-wrap"><canvas id="chart" width="900" height="300" aria-label="Capacity–Voltage 차트"></canvas></div>
        <table id="tbl" aria-label="예측 테이블">
          <thead><tr><th>Voltage (V)</th><th>Capacity (Ah)</th><th>구간</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </article>
  </section>
</main>

<!-- onnxruntime-web -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script>
/* ===== 모델 파일 경로를 배포 구조에 맞게 수정 ===== */
const PATHS = {
  LOWER: "models/soc-cycle/lowercap_fused.onnx"
};
/* =============================================== */

const $ = (id)=>document.getElementById(id);
const q = (sel)=>document.querySelector(sel);
const warn = (m)=> $("warn").textContent = m || "";

// 전압 격자 생성 (내림차순)
const UPPER_V = arange(4.20, 3.89, -0.01); // 32개
const LOWER_V = arange(3.88, 2.50, -0.01); // 139개

let session = null;

async function ensureSession(){
  if(session) return;
  ort.env.wasm.numThreads = 3;
  ort.env.wasm.proxy = false;
  session = await ort.InferenceSession.create(PATHS.LOWER, {executionProviders:["wasm"]});
}

function arange(start, stop, step){
  const arr=[]; // 포함형
  const eps = 1e-9;
  if(step === 0) return arr;
  if(step > 0){
    for(let v=start; v<=stop+eps; v+=step) arr.push(round4(v));
  }else{
    for(let v=start; v>=stop-eps; v+=step) arr.push(round4(v));
  }
  return arr;
}
function round4(x){ return Math.round(x*10000)/10000; }

function parseNumbers(text){
  return text
    .split(/[\s,;]+/)
    .map(t=>t.trim())
    .filter(t=>t.length>0)
    .map(Number)
    .filter(v=>Number.isFinite(v));
}

function validateInputs(q32, peakI, peakV){
  if(q32.length !== 32){
    return "상단 Q는 정확히 32개여야 합니다. (4.20→3.89V 순서)";
  }
  if(!Number.isFinite(peakI) || !Number.isFinite(peakV)){
    return "dQ/dV 피크의 세기와 전압을 모두 입력하세요.";
  }
  // 피크 전압 대략적 범위 체크 (상단 구간 안)
  if(peakV > 4.21 || peakV < 3.80){
    return "피크 전압은 대략 3.80~4.20V 범위여야 합니다.";
  }
  return null;
}

function makeInputTensor(q32, peakI, peakV){
  // 주의: ONNX가 기대하는 순서 — 32개 Q 뒤에 Peak Intensity, Voltage
  const feats = Float32Array.from([...q32, peakI, peakV]);
  return new ort.Tensor('float32', feats, [1, 34]);
}

function drawCapacityVoltage(upperPairs, lowerPairs){
  const c = $("chart"), ctx=c.getContext("2d"), dpr = window.devicePixelRatio||1;
  const W = c.clientWidth, H = c.clientHeight;
  c.width = W*dpr; c.height = H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);

  const L=54,R=14,T=14,B=38, w=W-L-R, h=H-T-B;

  const allPairs = [...upperPairs, ...lowerPairs];
  if(allPairs.length===0) return;

  const xs = allPairs.map(p=>p.x);
  const ys = allPairs.map(p=>p.y);

  const xMin = Math.min(...xs), xMax = Math.max(...xs);
  // Voltage 축은 위로 갈수록 전압↑
  const yMin = Math.min(...ys), yMax = Math.max(...ys);

  const xTo = x => L + (w * (x - xMin) / Math.max(1e-12, (xMax - xMin)));
  const yTo = y => T + h - (h * (y - yMin) / Math.max(1e-12, (yMax - yMin)));

  // 축
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border') || '#e6eaf1';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(L,T); ctx.lineTo(L,T+h); ctx.lineTo(L+w,T+h);
  ctx.stroke();

  // 눈금/라벨 (X 용량)
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted') || '#536075';
  ctx.font = '12px system-ui';
  const xTicks = 5;
  for(let i=0;i<=xTicks;i++){
    const xv = xMin + (i*(xMax-xMin)/xTicks);
    const xx = xTo(xv), yy = T+h;
    ctx.beginPath(); ctx.moveTo(xx,yy); ctx.lineTo(xx,yy+5); ctx.stroke();
    ctx.fillText(xv.toFixed(2), xx-10, yy+18);
  }
  // Y 전압 눈금
  const yTicks = 5;
  for(let i=0;i<=yTicks;i++){
    const yv = yMin + (i*(yMax-yMin)/yTicks);
    const xx = L, yy = yTo(yv);
    ctx.beginPath(); ctx.moveTo(xx-5,yy); ctx.lineTo(xx,yy); ctx.stroke();
    ctx.fillText(yv.toFixed(2), xx-42, yy+4);
  }
  // 축 라벨
  ctx.save();
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted') || '#536075';
  ctx.font = '12px system-ui';
  ctx.fillText('Capacity (Ah)', L + w/2 - 40, T+h+30);
  ctx.translate(16, T + h/2); ctx.rotate(-Math.PI/2);
  ctx.fillText('Voltage (V)', -36, 0);
  ctx.restore();

  // 상단(입력) 구간: 회색선
  if(upperPairs.length>0){
    ctx.strokeStyle = '#9aa5b1'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xTo(upperPairs[0].x), yTo(upperPairs[0].y));
    for(let i=1;i<upperPairs.length;i++){
      ctx.lineTo(xTo(upperPairs[i].x), yTo(upperPairs[i].y));
    }
    ctx.stroke();
  }

  // 하단(예측) 구간: 파란선
  if(lowerPairs.length>0){
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xTo(lowerPairs[0].x), yTo(lowerPairs[0].y));
    for(let i=1;i<lowerPairs.length;i++){
      ctx.lineTo(xTo(lowerPairs[i].x), yTo(lowerPairs[i].y));
    }
    ctx.stroke();
  }
}

function fillTable(upperPairs, lowerPairs){
  const tb = q('#tbl tbody'); tb.innerHTML = '';
  const addRow = (V,Q,seg)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${V.toFixed(2)}</td><td>${Q.toFixed(6)}</td><td>${seg}</td>`;
    tb.appendChild(tr);
  };
  // 상단 먼저(전압 내림차순)
  for(let i=0;i<upperPairs.length;i++){
    addRow(upperPairs[i].y, upperPairs[i].x, '상단');
  }
  // 하단(전압 내림차순)
  for(let i=0;i<lowerPairs.length;i++){
    addRow(lowerPairs[i].y, lowerPairs[i].x, '하단(예측)');
  }
}

async function run(){
  try{
    warn(""); await ensureSession();

    const q32 = parseNumbers($("Q32").value);
    const peakI = +$("peakI").value;
    const peakV = +$("peakV").value;

    const err = validateInputs(q32, peakI, peakV);
    if(err){ warn(err); return; }

    // ONNX 추론
    const inputName = session.inputNames[0];
    const feeds = {};
    feeds[inputName] = makeInputTensor(q32, peakI, peakV);
    const out = await session.run(feeds);
    const outputName = session.outputNames[0];
    const pred = Array.from(out[outputName].data); // 길이 139

    // 그래프용 (X=Capacity, Y=Voltage)
    const upperPairs = UPPER_V.map((V, i)=>({x: q32[i], y: V}));
    const lowerPairs = LOWER_V.map((V, i)=>({x: pred[i], y: V}));

    drawCapacityVoltage(upperPairs, lowerPairs);
    fillTable(upperPairs, lowerPairs);

  }catch(e){
    console.error(e);
    warn("실행 오류: " + (e?.message||e));
  }
}

$("runBtn").addEventListener("click", run);
$("demoBtn").addEventListener("click", ()=>{
  // 간단 데모: 32개 Q를 완만히 증가시키고 피크는 3.95V, 0.12로
  const demoQ = [];
  for(let i=0;i<32;i++){ demoQ.push( (i*0.03).toFixed(4) ); }
  $("Q32").value = demoQ.join(", ");
  $("peakI").value = "0.12";
  $("peakV").value = "3.95";
  warn("");
});
$("clearBtn").addEventListener("click", ()=>{
  $("Q32").value = ""; $("peakI").value = ""; $("peakV").value = "";
  warn(""); const c=$("chart"); c.getContext("2d").clearRect(0,0,c.width,c.height);
  q('#tbl tbody').innerHTML = '';
});
</script>
</body>
</html>
